<html>
  <head>   
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAqwwIT8aSIQ03hXvYlXzOvRZ08Rv7LWDQ&sensor=false"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/annyang/1.1.0/annyang.min.js"></script>
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #okperson { display: none; }
      #map-canvas {
        display:none;
      }
      #calculator {
        display:none;
      }
    </style>
  </head>
  <body>
    <h3>OK Hangout</h3>
    
    <div id="container">
    <div>Say "OK Hangout"</div>
    <div id="okperson">OK, Human.</div>
    <div id="map-canvas" style="width:800px;height:500px;"></div>
    <div id="calculator"></div>
    </div>

    <script>

      var geocoder;
      var map;

      function initialize() {
        geocoder = new google.maps.Geocoder();
        var mapOptions = {
          center: new google.maps.LatLng(-34.397, 150.644),
          zoom: 8
        };
        map = new google.maps.Map(document.getElementById("map-canvas"),
            mapOptions);
      }

      function locate(location) {
        geocoder.geocode( { 'address': location}, function(results, status) {
          if (status == google.maps.GeocoderStatus.OK) {
            map.setCenter(results[0].geometry.location);
            var marker = new google.maps.Marker({
                map: map,
                position: results[0].geometry.location
            });
          } else {
            console.log('Geocode was not successful for the following reason: ' + status);
          }
        });
      }

      google.maps.event.addDomListener(window, 'load', initialize);

      function evaluate(expression) {
        console.log("evaluate: " + expression);
        var re = /^(\d+) (\-|X|divided by|\+|times|plus)\s?(\d+)$/;
        var exArr = expression.match(re);
        var operator;
        switch(exArr[2]) {
          case "X":
            operator = "*";
            break;
          case "times":
            operator = "*";
            break;
          case "divided by":
            operator = "/";
            break;
          case "plus":
            operator = "+";
            break;
          case "-":
            operator = "-";
            break;
        }
        var expression = exArr[1] + operator + exArr[3];
        var answer = eval(expression);
        $('#calculator').text(answer);
        $('#calculator').fadeIn();
      }

      if (annyang) {
        var showFlickr = function(tag) {
          console.log('flicka');
          console.log($("#container").html);
          $("#container").empty();
          $("#container").append("<div id='flickrLoader'><p></p></div><div id='flickrGallery'></div>")
          $('#flickrLoader p').text('Searching for '+tag).fadeIn('fast');
          var url = '//api.flickr.com/services/rest/?method=flickr.photos.search&api_key=a828a6571bb4f0ff8890f7a386d61975&sort=interestingness-desc&per_page=9&format=json&callback=jsonFlickrApi&tags='+tag;
          $.ajax({
            type: 'GET',
            url: url,
            async: false,
            jsonpCallback: 'jsonFlickrApi',
            contentType: "application/json",
            dataType: 'jsonp'
          });
        };

        var jsonFlickrApi = function(results) {
          $('#flickrLoader p').fadeOut('slow');
          var photos = results.photos.photo;
          $('flickrGallery').empty();
          $.each(photos, function(index, photo) {
            $(document.createElement("img"))
              .attr({ src: '//farm'+photo.farm+'.staticflickr.com/'+photo.server+'/'+photo.id+'_'+photo.secret+'_s.jpg' })
              .addClass("flickrGallery")
              .appendTo(flickrGallery);
          });
        };

        // Let's define a command.
        var commands = {
          'ok hangout': function() { $('#okperson').show(); console.log('person!')},
          'show me *term': showFlickr,
          'where is *location': locate,
          'calculate *expression': evaluate
        };

        // Add our commands to annyang
        annyang.addCommands(commands);

        // Start listening.
        annyang.start();
      }
    </script>

  </body>
</html>